\chapter{Controller description} \label{cha:description}

This chapter contains a description of the controller strategy, architecture, filters, parameters, and in-/outputs. The controller is a further development of a previous controller used at DTU Wind Energy under the version 11. The new developments are inspired by Bossanyi's controller for the 5MW NREL reference turbine \cite{Bossanyi09}, where the power error feedback in the pitch controller that keeps the pitch at its minimum below rated power operation represents the most significant change.

The controller is only considering low speed shaft (LSS) measures of rotational speeds and torques, i.e., there is no gearbox on the drivetrain. The controller still be used for turbines with a gearbox, when the user transforms torques and speeds between the LSS and HSS using the gear ratio.

\section{Strategy and architecture}

A diagram of the entire controller is shown in Figure~\ref{f:diagram}. The routes of this diagram that are active when the turbine is operating below rated power, herein called \emph{partial load} operation, are shown in Figure~\ref{f:diagram_part}. The routes that are active in \emph{full load} operation are shown in Figure~\ref{f:diagram_full}. These two regions of operation are first described before the switching between is explained. The discrete filters denoted by the functions $f_1$, $f_2$, $f_p$, and $f_n$ in the diagrams are described and tested in Appendix~\ref{ch:filters}.

\subsection{Partial load operation}

The strategy for optimal $C_P$ tracking in partial load operation is based on a balance between generator and aerodynamic torques to obtain a close to optimal tip speed ratio. To avoid the feedback of higher frequency dynamics (e.g. the drivetrain torsion mode), the torque reference $Q_{ref,k}$ at the current step $k$ is computed based on a second order low-pass filtered LSS generator speed as $K \bar \Omega_k$. This feedback is enforced by setting the torque limits for the PID controller to $Q_{g,min,k}=Q_{g,max,k}=K\bar \Omega_k$ whenever the filtered rotational speed $\bar \Omega_k$ is not close to the minimum speed $\Omega_{min}$, or the rated speed $\Omega_0$. When the rotational speed is close to its bounds, these torque limits will open according to the interpolation factors $\sigma_{min,k}$ and $\sigma_{max,k}$. The torque reference will then be given by the PID controller based on the speed error $e_{Q,k}=\bar\Omega_k -\Omega_{set,k}$, where the set point is the minimum, or rated speed. Because the rotor speed is bounded, the power loss can often be minimized be performing some adjustment of the minimum pitch. A first order low-pass filtered wind speed measured at hub height $\bar V_k$ is used as parameter for varying the minimum pitch angle $\theta_{min,k}=\theta_{min}(\bar V_k)$ based on a look-up table provided by the user. The power error feedback of pitch PID controller ensures that the pitch reference is kept at this minimum pitch angle.

\begin{sidewaysfigure}
\centerline{\epsfig{figure=discrete_diagram.eps,width=1.05\textheight} }
\caption{Diagram of the discrete controller. Note that $k$ denotes the current time step. \label{f:diagram}}
\end{sidewaysfigure}

\begin{sidewaysfigure}
\centerline{\epsfig{figure=discrete_diagram_part.eps,width=1.05\textheight} }
\caption{Active routes during partial load operation in the controller diagram in Figure~\ref{f:diagram}. \label{f:diagram_part}}
\end{sidewaysfigure}

\begin{sidewaysfigure}
\centerline{\epsfig{figure=discrete_diagram_full.eps,width=1.05\textheight} }
\caption{Active routes during full load operation in the controller diagram in Figure~\ref{f:diagram}. \label{f:diagram_full}}
\end{sidewaysfigure}

The interpolation factors for the opening of the torque limits are based on how close the second order low-pass filtered generator speed is from its minimum and rated speeds. The limits can be opened gradually over an interval as described by the function
\begin{equation}\label{e:sigma}
\sigma\left(x_0,x_1;x\right) = \left\{
\begin{array}{rl}
0 & \forall x<x_0 \\
a_3x^3 + a_2x^2 + a_1x + a_0& \forall x\in[x_0:x_1[\\
1 & \mbox{otherwise}
\end{array} \right.
\end{equation}
where the coefficients of the spline are
\begin{equation}\label{e:sigmacoef}
a_3=\frac{2}{\left(x_0-x_1\right)^3}, \;\;\;\;
a_2=\frac{-3 \left(x_0+x_1\right)}{\left(x_0-x_1\right)^3}, \;\;\;\;
a_1=\frac{6 x_1 x_0}{\left(x_0-x_1\right)^3}, \;\;\;\;
a_0=\frac{\left(x_0-3 x_1\right) x_0^2}{\left(x_0-x_1\right)^3}
\end{equation}
The function is programmed such that if $x_0 \geq x_1$ then the $\sigma$-function becomes
\begin{equation}\label{e:sigma_if}
\sigma\left(x_0,x_0;x\right) = \left\{
\begin{array}{rl}
0 & \forall x<x_0 \\
1 & \mbox{otherwise}
\end{array} \right.
\end{equation}
Figure~\ref{f:sigma} shows an example of the $\sigma$-function where $x_0=1$ and $x_1=2$. In an actual implementation of the controller, this smooth function with a third order polynomial may be an unnecessary complexity, which can been replaced by a linear interpolation function.

Figure~\ref{f:torque_limits} shows the torque limits in partial load operation of the DTU 10~MW RWT, where the minimum speed is 5~rpm and rated speed is 9.6~rpm. Several operational regions can be seen here. Namely the bellow minimal rotational speed region, variable speed region with exclusion zone functionality, transient variable to constant speed region and finally constant speed region. The generator torque limits are set to be open in bellow minimal rotor speed, where the maximal torque limit is set to
\begin{equation}\label{e:Tg_blw_min_w}
Q_{g,max} = \max\left\{
\begin{array}{l}
K\cdot \Omega_{min}^2 \\
K\cdot \bar\Omega_k^2
\end{array} \right.
\end{equation}
%$Q_{g,max}= K\dot\Omega_{min}^2$
and minimal torque is equal to zero. The generator torque limits are closed approximately 5~\% above the minimum speed $\Omega_{min}$ and start opening again at 90~\% and are fully open at 95~\% of the rated speed. If the exclusion zone functionality is active, the torque limits starts to open at 95~\% of the exclusion zone minimal speed $\omega_{L}$ and are closed approximately 5~\% above the exclusion zone maximal speed $\omega_{H}$. Where the spline function is used ot guarantee smooth transient. The maximal torque limit is set to $Q_{g,max}$ 5~\% above the $T_{G_{\omega_{L}}}$ and the minimal torque is set to $Q_{g,min}$ 95~\% of the $T_{G_{\omega_{H}}}$.

\begin{figure}[t]
\centerline{\epsfig{figure=sigma.eps,width=0.45\textheight} }
\caption{Example of the $\sigma$-function \eqref{e:sigma} where $x_0=1$ and $x_1=2$. \label{f:sigma}}
\end{figure}

\begin{figure}[t]
\centerline{
\epsfig{figure=torque_limits_rsa.eps,width=0.6\textwidth} }
\caption{Torque limits in partial load operation of the DTU 10~MW RWT, where the minimum speed is 5~rpm and rated speed is 9.6~rpm. The limits are set to be closed approximately 5~\% above the minimum speed and start opening again at 90~\% and are fully open at 95~\% of the rated speed. \label{f:torque_limits}}
\end{figure}

\subsection{Full load operation}

In full load operation, the torque limits are closed around the torque given by the selected power control strategy, either constant power $P_0/\Omega_k$, or constant torque $P_0/\Omega_0$, where $P_0$ is the rated power. Note that the unfiltered measured LSS generator speed $\Omega_k$ is used for computation of the reference torque in the constant power control.

The pitch reference angle is obtained from a combined PI feedback of the generator speed and power errors, and a possible differential feedback of the speed error. The speed error is obtained as the difference between the second order low-pass filtered LSS generator speed and the rated speed. The power error is the difference between the reference power $P_{ref,k}=Q_{ref,k}\Omega_k$ and the rated power $P_0$. Both errors are notch filtered around the frequency specified by the user as the free-free drivetrain frequency. This frequency is assumed to be constant although HAWCStab2 eigenvalue analysis often show a small variation with operational point (wind speed). Note that both errors contribute to the same proportional term ($\theta_{P,k}$) and same integral term ($\theta_{I,k}$). The latter is important because it ensures that the reference pitch angle is kept at the minimum pitch angle until rated power is reached; assuming that the right weighting between the integral speed error gain $k_I$ and power error gain $k_I^P$ has been selected by the user.

The anti-windup is performed such that the controller will react quickly with increased pitch angle if the reference power signal suddenly increased above the rated power level: In each time step, the minimum pitch limit is enforced on the reference pitch which is the sum of the proportional, differential, and integral terms $\theta_{ref,k}=\max\left(\theta_{min,k},\theta_{P,k}+\theta_{D,k}+\theta_{I,k}\right)$. The value of the integral term to be used for the integration in the next time step is then recalculated as $\theta_{I,k}=\theta_{ref,k}-\theta_{P,k}-\theta_{D,k}$, which only makes a change to the integral term if the reference pitch is on the minimum limit $\theta_{ref,k}=\theta_{min,k}$. Below rated power, where the proportional term is negative because the rotational speed error is kept close to zero by the torque PID controller, the integral term will therefore be positive. If the reference power is increased and becomes close to rated power (due to the reaction of the torque PID controller to an increased wind speed), then the proportional term will then come close to zero whereas the integral will still be positive and the resulting pitch reference angle will be positive, whereby large power and speed variations are avoided. Note that the same anti-windup scheme is used in the torque PID controller.

The first order low-pass filtered mean of the blade pitch angles $\bar \theta_{m,k}$ is used for scheduling of the gains of the pitch PID controller. A quadratic dependency of the aerodynamic torque gain with collective pitch angle is assumed as
\begin{equation}\label{e:gainsch}
\frac{\partial Q_A}{\partial \theta}= \left. \frac{\partial Q_A}{\partial \theta}\right|_{\theta=0}\left(1 + \frac{\theta}{K_{1}} + \frac{\theta^2}{K_{2}}\right)
\end{equation}
where $Q_A$ denotes the aerodynamic torque, $\theta$ is the collective pitch angle, and $\left. \frac{\partial Q_A}{\partial \theta}\right|_{\theta=0}$ is the aerodynamic gain at zero pitch. The parameters of this expression $K_1$ and $K_2$ can be obtained from curve fitting to the derivative of the aerodynamic torque with respect to collective pitch angle assuming quasi-steady aerodynamics and \emph{frozen wake} (constant induced velocities) as
\begin{equation}\label{e:dqadt}
\frac{\partial Q_A}{\partial \theta} = \frac12 \rho B \int_0^R c(r) U(r)^2 \left(
  C_L'(\alpha(r)) \sin \varphi(r)
- C_D'(\alpha(r)) \cos \varphi(r) \right) r dr
\end{equation}
where $B$ is the number of blades, $R$ is the outer radius of the rotor, $c(r)$ is the radial chord distribution, $U(r)$ is the mean steady state relative inflow velocity along the blade, $C_L'$ and $C_D'$ are the gradients of the lift and drag coefficient curves evaluated at the mean steady state angle of attack $\alpha(r)$ along the blade, and $\varphi(r)$ is the spanwise distribution of inflow angles relative to the rotor plane.

Figure~\ref{f:gainsch} shows the aerodynamic torque gradients obtained from HAWCStab2 for the DTU 10~MW RWT together with the fit of the quadratic expression \eqref{e:gainsch}. The fitted are parameters shown as inputs number 21 and 22 in Table~\ref{t:init} of Section~\ref{s:par}. Often, a linear fit is sufficient and it is assumed when the user enters $K_2=0$ (note that $K_1$ then is the angle where the aerodynamic gain is doubled). The gain scheduling factor based on the filtered mean pitch angle $\eta_{A,k}$ is the inverse of the expression in the parenthesis of \eqref{e:gainsch}. A nonlinear gain factor $\eta_{nl,k}$ based on the generator speed error is also added for increased sensitivity of the pitch PID controller by large speed excursions.

\begin{figure}[b!]
\centerline{\epsfig{figure=gainsch.eps,width=1\textwidth} }
\caption{Aerodynamic torque gains for the DTU 10~MW RWT obtained from HAWCStab2. \label{f:gainsch}}
\end{figure}

\subsection{Switching between partial and full load operation}

The switching between partial and full load control of the generator torque is based on a first order low-pass filtered switching variable $\sigma_{\theta,k}$ that is driven by a $\sigma$-function evaluation using the measured mean pitch angle $\theta_m$. The time constant is the rotational period at rated speed. As explained above, the anti-windup of the combined integral term of the pitch PID controller will ensure that the reference pitch angle raises above its minimum value when the torque PID controller of generator speed results in a reference power close to the rated power level. The user can define at how many degrees above the minimum pitch this switching shall occur. Good experiences have been obtained with a hard switch at $\theta_{f_1}=\theta_{f_2}=\theta_{min,k}+0.5$~deg.

\subsection{Drivetrain damper}\label{s:dmp}

The measured generator LSS speed $\Omega_k$ is fed through a band-pass filter with the free-free drivetrain torsional frequency $\omega_n$ as center frequency (see example of the filter in Appendix~\ref{ch:filters}). The filtered speed $\Omega_{d,k}$, containing in-phase variations with frequencies around this frequency, is then multiplied by a gain factor $k_{dmp}$ and added to the torque feedback from the PID controller to give the generator torque reference. Note that this drivetrain damper is always active when $k_{dmp} \neq 0$.

\subsection{Additional non-linear pitch control term}

This term should only be active during extreme event where severe over-speed can occur.

\begin{align}
	\dot{\theta}_{+} &= \dot{\theta}_{+} + k_{os} ( \dot{\bar{\Omega}}_k/\Omega_{os} + e_{\Omega,k}/\dot{\Omega}_{os} ) &\text{, for } ( \dot{\bar{\Omega}}_k/\Omega_{os} + e_{\Omega,k}/\dot{\Omega}_{os} ) > 1 \\
	\dot{\theta}_{+} &= \dot{\theta}_{+} &\text{, for } ( \dot{\bar{\Omega}}_k/\Omega_{os} + e_{\Omega,k}/\dot{\Omega}_{os} ) \leq 1	
\end{align}

This control block is only active if ($\Omega_{os}$,$\dot{\Omega}_{os}$,$k_{os}$) $\neq$ 0.

\subsection{Aerodynamic damping gain}
\subsection{K-Omega-Omegadot}
\subsection{TSR tracking}
\subsection{Storm control}

\section{Parameters}\label{s:par}

All parameters of the controller are transferred to the DLL using HAWC2 commands for the \verb|init_regulation| routine of the type2 DLL \cite{Larsen12}. Details of all 42 parameters are given in Table~\ref{t:par}, where the notation of the parameters used in the diagram of Figure~\ref{f:diagram} and some additional notations can also be seen. Additional features can be enabled by using the \verb|init_regulation_2| instead, this routine requires 51 parameters, where the fist 42 are identical to those of \verb|init_regulation|. The additional parameters can be found in Table~\ref{t:par2}

\begin{table}[!htbp]
\begin{center}
\begin{tabular}{r|c|p{11.5cm}}
Input &  & Additional explanation if assumed needed \\ \hline
1 & $P_0$ & Rated power [kW].\\
2 & $\Omega_{min}$ & Minimum rotor speed [rad/s].\\
3 & $\Omega_0$ & Rated rotor speed [rad/s]. \\
4 & -& Maximum allowable generator torque [Nm]. An upper limit set on the torque reference signal. \\
5 & -& This number is the minimum pitch angle $\theta_{min}$ in degrees, which is set to a constant if this input is less than 90~deg. Otherwise, the init routine will search for a file with the name ``wptable.n'', where ``n'' is a character string obtained from the integer value of the input. In the shown example, this file is therefore ``wptable.100''. The file format is first line contains an integer with the number of subsequent lines, which contain two numbers each, wind speed and minimum pitch angle in degrees. An example is shown in Table~\ref{t:wptable}.\\
6 & $\theta_{max}$& Maximum pitch angle [deg]. \\
7 & -& Maximum pitch velocity operation [deg/s]. An upper limit set on the rate of change of the pitch reference signal.\\
8 & $\omega_{\Omega}$ & Frequency of generator speed filter [Hz]. \\
9 & $\zeta_{\Omega}$ & Damping ratio of speed filter [-]. \\
10 & $\omega_n$ & Frequency of free-free DT torsion mode [Hz], if zero no notch filter used. \\
11 & $K$ & Optimal $C_P$ tracking factor [Nm/(rad/s)$^2$], $K=\eta \frac12 \rho A C_{P,opt} R^3/\lambda_{opt}^3$. \\
12 & $k_P^g$ & Proportional gain of torque controller [Nm/(rad/s)]. \\
13 & $k_I^g$ & Integral gain of torque controller [Nm/rad]. \\
14 & $k_D^g$ & Differential gain of torque controller [Nm/(rad/s$^2$)]. \\
15 & -& Generator control strategy [1=constant power, 2=constant torque]. \\
16 & $k_P$ & Proportional gain of pitch controller [rad/(rad/s)]. \\
17 & $k_I$ & Integral gain of pitch controller [rad/rad].\\
18 & $k_D$ & Differential gain of pitch controller [rad/(rad/s$^2$)]. \\
19 & $k_P^P$ & Proportional power error gain [rad/W]. \\
20 & $k_I^P$ & Integral power error gain [rad/(Ws)]. \\
21 & $K_1$ & Coefficient of linear term in aerodynamic gain scheduling [deg]. \\
22 & $K_2$ & Coefficient of quadratic term in aerodynamic gain scheduling [deg$^2$]. If this factor $K_2$ is set to zero then the controller will assumed a linear gain scheduling. The $K_1$ is then the pitch angle where the aerodynamic torque gain has doubled from its value at zero pitch.\\
23 & $\Omega_2/\Omega_0$ & Normalized speed where the pitch controller gains are doubled.\\
24 & -& Cut-in time [s], if zero no cut-in simulated. \\
25 & -& A time delay for the cut-in procedure given in the unit [1/1P] corresponding to the rotational period at rated speed.\\
26 & $\tau_{out}$ & Cut-out time [s], if zero no cut-out simulated. \\
27 & -& Time constant for first order filter lag of torque cut-out [s]. \\
28 & -& Stop type [1=linear two pitch speed stop, 2=exponential pitch speed stop] as described in Section~\ref{s:cutout}. \\
29 & $\tau_1$ & Time delay for pitch stop 1 [s]. \\
30 & -& Maximum pitch velocity during stop 1 [deg/s]. \\
31 & $\tau_2$ & Time delay for pitch stop 2 [s].\\
32 & -& Maximum pitch velocity during stop 2 [deg/s].
\end{tabular}
\end{center}
\end{table}
\begin{table}[t!]
\begin{center}
\begin{tabular}{r|c|p{11.5cm}}
Input &  & Additional explanation if assumed needed \\ \hline
33 & $\theta_{f_0}$ & Lower angle above lowest minimum pitch angle for switch [deg]. \\
34 & $\theta_{f_1}$ & Upper angle above lowest minimum pitch angle for switch [deg]. \\
35 & $\gamma$ & Percentage of the rated speed when the torque limits are fully opened $\Omega_{max_2}=\gamma\Omega_0$ to let PID controller be active, and the opening starts at $\Omega_{min_2}=(2 \gamma -1)\Omega_0$. The same percentage is used for opening the torque limits for PID control around the minimum rotational speed, where the torque limits start to open at $\Omega_{max_1}=\Omega_{min}/\gamma$ and fully open at $\Omega_{min_1}=\Omega_{min}$. \\
36 & $\tau_V \Omega_0 /(2\pi)$ & Time constant of 1st order filter on wind speed used for minimum pitch [1/1P]. \\
37 & $\tau_{\theta} \Omega_0 /(2\pi)$ & Time constant of 1st order filter on pitch angle for gain scheduling [1/1P]. \\
38 & $k_{dmp}$ & Proportional gain of DT damper [Nm/(rad/s)], requires frequency in input 10. \\
\hline
39 & -& Over speed percentage  [\%], before initiating shut down. \\
\hline
40 & $\Omega_{os}$ & Rotor speed error scaling factor  [rad/s]. \\
41 & $\dot{\Omega}_{os}$ & Rotor acceleration error scaling factor  [rad/s${}^2$]. \\
42 & $k_{os}$ & Pitch rate gain  [rad/s].
\end{tabular}
\caption{All parameters of the controller related to the parameters shown in the diagram in Figure~\ref{f:diagram} . \label{t:par}}
\end{center}
\end{table}

\begin{table}[t]
\begin{center}
\begin{verbatim}
7
 0.0 3.0
 4.0 3.0
 5.0 2.5
 6.0 1.7
 7.0 0.8
 8.0 0.0
50.0 0.0
\end{verbatim}
\caption{Example of a ``wptable.n'' file. First line contains an integer with the number of subsequent lines, which contain two numbers each, wind speed and minimum pitch angle in degrees.\label{t:wptable}}
\end{center}
\end{table}

\begin{table}[!htbp]
\begin{center}
\begin{tabular}{r|c|p{11.5cm}}
Input &  & Additional explanation if assumed needed \\ \hline
43 & $\kappa$ & For K-Omega-Omegadot controller\\
44 & $\lambda_{opt}$ & Optimal TSR for TSR tracking, active if $K$ (parameter 11) is 0.\\
45 & $R$ & Rotor radius for TSR tracking.\\
\hline
46 & $Kp_\Omega$ & Aerodynamic damping gain\\
47 & $k1_\Omega$ & Aerodynamic damping gain scheduling parameter.\\
48 & $k2_\Omega$ & Aerodynamic damping gain scheduling parameter.\\
\hline
49 &  & Flag to activate storm controller\\
50 &  & Wind speed for storm controller (e.g. 25)\\
51 &  & Cut-out wind speed (e.g. 45)
\end{tabular}
\caption{All parameters of the controller related to additional features.}
\label{t:par2}
\end{center}
\end{table}

\section{Inputs and outputs}

As input during simulations, the controller requires the time [s], the generator LSS speed [rad/s], the pitch angles of three blades [rad], and the three components of the wind speed at hub height [m/s], where the first and second of these three components must be the two horizontal components that are used internally to compute the horizontal vector sum. Table~\ref{t:input} shows the HAWC2 commands that provide these eight controller inputs for the DTU 10~MW RWT. Note that if the rotor only has two blades, then the controller may still be used by repeating a blade pitch angle output to the controller. However, this trick is only valid if there is no additional cycle, or individual pitch controller appended to this controller.

\begin{table}[t]
\center
\begin{verbatim}
general time                           ; [s]
constraint bearing1 shaft_rot 1 only 2 ; [rad/s] Generator LSS speed
constraint bearing2 pitch1 1 only 1    ; [rad]
constraint bearing2 pitch2 1 only 1    ; [rad]
constraint bearing2 pitch3 1 only 1    ; [rad]
wind free_wind 1 0.0 0.0 -124.6        ; [m/s] global coords at hub height
constant 0.0                         ; [rad/s] Feed-forward pitch rate
\end{verbatim}
\caption{HAWC2 commands that define the input to the controller DLL. Note that the command ``wind free\_wind 1 x y z'' will give all three components of the free wind at the point x,y,z, both in global coordinates \cite{Larsen12}, thus in all eight inputs. \label{t:input}}
\end{table}

Table~\ref{t:output} contains a list of the controller outputs to the simulation, where the generator torque reference and pitch angle references for three blades are the

\begin{table}[t]
\center
\begin{tabular}{r|ll}
Channel & Description \\ \hline
 1& Generator torque reference, $Q_{ref,k}$            &[Nm]\\
 2& Pitch angle reference of blade 1, $\theta_{ref,k}$      &[rad]\\
 3& Pitch angle reference of blade 2, $\theta_{ref,k}$      &[rad]\\
 4& Pitch angle reference of blade 3, $\theta_{ref,k}$      &[rad]\\
 5& Power reference, $P_{ref,k}$                       &[W]\\
 6& Filtered wind speed, $\bar V_k$                   &[m/s]\\
 7& Filtered rotor speed, $\bar \Omega_k$                  &[rad/s]\\
 8& Filtered rotor speed error for torque, $e_{Q,k}$ &[rad/s]\\
 9& Band-pass filtered rotor speed, $\Omega_{d,k}$         &[rad/s]\\
10& Proportional term of torque controller, $Q_{P,k}$    &[Nm]\\
11& Integral term of torque controller, $Q_{I,k}$    &[Nm]\\
12& Minimum limit of torque, $Q_{g,min,k}$               &[Nm]\\
13& Maximum limit of torque, $Q_{g,max,k}$               &[Nm]\\
14& Torque limit switch based on pitch, $\sigma_{\theta,k}$    &[-]\\
15& Low-pass filtered rotor speed error for pitch controller, $e_{\Omega,k}$  &[rad/s]\\
16& Low-pass and notch filtered power error for pitch controller, $\bar e_{P,k}$                 &[W]\\
17& Proportional term of pitch controller, $\theta_{P,k}$ &[rad]\\
18& Integral term of pitch controller, $\theta_{I,k}$     &[rad]\\
19& Minimum limit of pitch, $\theta_{min,k}$                &[rad]\\
20& Maximum limit of pitch, $\theta_{max}$                &[rad]\\
21& Torque reference from DT damper, $Q_{dmp,k}$       &[Nm] \\
22& Status signal,        &[-] \\
23& Pitch rate to be added to pitch controller,        &[rad/s]
\end{tabular}
\caption{Outputs from the controller DLL, where only the first two are needed. The rest are for analysis of controller behavior.  \label{t:output}}
\end{table}

\section{Cut-in procedure - start up at any wind speed}

The controller has a very simplified cut-in procedure, which is not intended to model a real cut-in, but rather to enable start-up of normal operation DLCs at any wind speed. The blades are initially pitched out to maximum pitch and then at a given time in the simulation (input 24), the blades are pitched towards minimum pitch with zero generator torque reference. As the rotor speed increases, a first order filter of the difference the measured rotational speed and the minimum rotational speed with the time constant of 1/1P (one rotational period at rated speed) is updated in each time step $k$ as
\begin{equation}
\label{e:speedtrack}
\Delta \Omega_k = f_1 \left(2\pi/\Omega_0; \Delta \Omega_{k-1} , \Omega_{k}-\Omega_{min} , \Omega_{k-1}-\Omega_{min}\right)
\end{equation}
During this speed-up, the speed error PID terms of the pitch controller is active at a quarter of their normal gains and the set point of it is the minimum rotor speed. The power error gains are set to zero, otherwise it will stay at minimum due to the zero generator torque reference (the factor of a quarter is chosen based on trial and error). The pitch controller thereby catches the rotational speed at the minimum speed and when $\Delta \Omega_k$ become within 2~\% of the minimum speed, the acceleration of the rotor is assumed to be under control and a generator cut-in time is registered. The torque reference is thereafter ramped up using the $\sigma$-function in Equation~\eqref{e:sigma} to its value determined by the normal controller at a user-defined time after the generator cut-in time. In the same period, the rotational speed set point for the pitch controller is ramped up to the rated speed $\Omega_0$, and both speed and power error gains are ramped up to their values determined by the normal gain scheduling. The controller should thereafter be operating normally, and this start-up will at moderate to high wind speeds take less than 100~s for the DTU 10~MW RWT.

There should be no need for wind ramping for the controller to start up, however, caution should be made on not to start high wind speed (above rated) simulations with too high initial rotational speed. Too high initial rotor speed may cause the pitch and torque controllers to overreact and they may enter a state of competition. If the user can allow long start-up periods then the most stable way is set a late cut-in time to let the rotor slow down to idling before the cut-in starts. However, at low wind speeds, the start-up will then take a long time, and a very early cut-in (e.g. 0.1~s) is recommended, combined with an initial rotational speed is set to a value 50-75~\% of the minimum speed.


\section{Cut-out procedures} \label{s:cutout}

The user may specify a time in the simulation for the cut-out of the generator in input 26 (let it be denoted $\tau_{out}$). A first order filter will be driven by the torque reference signal until this cut-out time, whereafter the filter is let to decay with a user specified time constant (input 27), and the torque reference will set equal to this decaying signal.

At the generator cut-out time plus the first user specified time delay in input 29 (let it be denoted $\tau_1$), the blades will start to pitch out by setting the reference pitch angle to the maximum pitch angle (let it be denoted $\theta_{max}$). The user can specify two different types of pitch velocity schemes, either linear pitching with two different constant speeds, or exponential pitching where the velocity changes as an exponential function. In the linear pitching scheme, the maximum pitch velocity is initial set to the pitch velocity specified in input 30. After additional time given by the ``time delay of pitch stop 2'' in input 31, let it be denoted $\tau_2$, the maximum pitch velocity is then set to the pitch velocity specified in input 32. In the exponential pitch scheme, the maximum pitch velocity will start at the velocity given by $\theta_{max}/\tau_2$, whereafter this velocity will decay as the exponential function $\exp\left(-(t-\tau_{out}-\tau_1)/\tau_2\right)$ until $(t-\tau_{out}-\tau_1)/\tau_2>10$, or this decaying maximum pitch velocity is lower than the pitch velocity specified in input 32, which is the value that the maximum pitch velocity will have thereafter.

\section{Programming}

The controller is programmed in Fortran90 using the format of the \emph{type2 DLL interface for HAWC2} \cite{Larsen12} and the source code is listed in Appendix~\ref{ch:source}. 